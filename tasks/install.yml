---
# Â©Copyright 2015-2016 Hewlett Packard Enterprise Development Company, LP

- include: pip_index.yml

- name: Install deps to avoid pip doing compilation or enable it
  apt: name={{item}} state=present
  with_items: "{{ dependencies_deb }}"
  when: ansible_os_family == 'Debian'

- name: Install rpms to avoid pip doing compilation or enable it
  yum: name={{item}} state=present
  with_items: "{{ dependencies_redhat }}"
  when: ansible_os_family == 'RedHat'

- name: Install rpms to avoid pip doing compilation or enable it
  zypper: name={{item}} state=present
  with_items: "{{ dependencies_suse }}"
  when: ansible_os_family == 'Suse'

- name: Upgrade pip in virtualenv
  pip: name=pip state=latest virtualenv="{{monasca_virtualenv_dir}}"

- name: Upgrade setuptools in virtualenv
  pip: name=setuptools state=latest virtualenv="{{monasca_virtualenv_dir}}"

- name: pip install latest monasca-agent in a virtualenv
  pip: name=monasca-agent state=latest virtualenv="{{monasca_virtualenv_dir}}" extra_args="{{monasca_pip_extra_args | default(omit)}}"
  notify: run monasca-setup
  when: monasca_agent_version is not defined and monasca_agent_branch is not defined

- name: pip install a specific version of monasca-agent in a virtualenv
  pip: name=monasca-agent state=present version="{{monasca_agent_version}}" virtualenv="{{monasca_virtualenv_dir}}" extra_args="{{monasca_pip_extra_args | default(omit)}}"
  notify: run monasca-setup
  when: monasca_agent_version is defined

- name: pip install a specific branch of monasca-agent in a virtualenv
  pip:
    name: "git+{{ monasca_agent_git_repo }}@{{ monasca_agent_branch }}"
    virtualenv: "{{ monasca_virtualenv_dir }}"
    editable: False
    extra_args: "{{ monasca_pip_extra_args | default(omit) }}"
  when: monasca_agent_branch is defined and monasca_agent_version is not defined

- name: pip install psutil==3.0.1
  pip: name=psutil version=3.0.1 virtualenv="{{monasca_virtualenv_dir}}"
  notify: run monasca-setup
